## Домашнее задание к занятию "7.1. Инфраструктура как код"

---
### Задача 1. Выбор инструментов.
Легенда
- Через час совещание на котором менеджер расскажет о новом проекте. 
- Начать работу над которым надо будет уже сегодня. 
- На данный момент известно, что это будет сервис, который ваша компания будет предоставлять внешним заказчикам. 
- Первое время, скорее всего, будет один внешний клиент, со временем внешних клиентов станет больше.
- Так же по разговорам в компании есть вероятность, что техническое задание еще не четкое, 
- что приведет к большому количеству небольших релизов, тестирований интеграций, откатов, доработок, то есть скучно не будет.

Вам, как девопс инженеру, будет необходимо принять решение об инструментах для организации инфраструктуры. 
На данный момент в вашей компании уже используются следующие инструменты:

- остатки AWS Сloud Formation,
- некоторые образы сделаны при помощи Packer ,
- год назад начали активно использовать Terraform,
- разработчики привыкли использовать Docker,
- уже есть большая база Kubernetes конфигураций,
- для автоматизации процессов используется Teamcity,
- также есть совсем немного Ansible скриптов,
- и ряд bash скриптов для упрощения рутинных задач.

Для этого в рамках совещания надо будет выяснить подробности о проекте, чтобы в итоге определиться с инструментами:
- Какой тип инфраструктуры будем использовать для этого проекта: изменяемый или не изменяемый?
- Будет ли центральный сервер для управления инфраструктурой?
- Будут ли агенты на серверах?
- Будут ли использованы средства для управления конфигурацией или инициализации ресурсов?

В связи с тем, что проект стартует уже сегодня, в рамках совещания надо будет определиться со всеми этими вопросами.

В результате задачи необходимо:

- Ответить на четыре вопроса представленных в разделе "Легенда".
Какие инструменты из уже используемых вы хотели бы использовать для нового проекта?
Хотите ли рассмотреть возможность внедрения новых инструментов для этого проекта?
Если для ответа на эти вопросы недостаточно информации, то напишите какие моменты уточните на совещании.

---
### Ответ:
-
          Главный посыл -     
          Процесс переноса старых исходников на новую инфраструктуру - очень длительный, а проект стартует уже завтра.
          В связи с этим предлагаю создать проект построения инфраструктуры  с нуля, 
          И запускать параллельные проекты по переносу старой блоков  автоматизации в новую среду,
          пошагово  выводя из эксплуатации инструменты, не входящие в выбранный стек технологий.

- Какой тип инфраструктуры будем использовать для этого проекта: изменяемый или не изменяемый?

      Какого типа  организация  ?
          Если организация-клиент - банк или другая финансовая компания, 
           или организация относится к  оборонке или военной промышленности - как в продашкене  , так и в разработке
          предпочтительнее неизменяемая архитектура . Это позвоит избежать дрейфа конфигураций.
          В таких компаниях  виртуальные машины  должны разворачиваются из стандартных шаблонов, 
          утвержденных службой безопасности банка, 
          а для военки - образы ОС должны соответствуют требования ФСТЭК.
    
          ДЛя коммерческих компаний изменяемую среду можно использовать как в продакшене , так и в разработке .
         
  Будет ли центральный сервер для управления инфраструктурой?

       Нет - Современные инструменты IaC не требуют наличия центрального сервера .
 
- Будут ли агенты на серверах?

       Агенты не нужны, поскольку не используются старые иснструменты IaC.
 
- Будут ли использованы средства для управления конфигурацией или инициализации ресурсов?
   
       Должна быть соблюдена Идемпотентость - главное свойство инструментов IAC .
       Поэтому без Ansible и Terraform не обойтись .

- Какие инструменты из уже используемых вы хотели бы использовать для нового проекта?

      Так как Terraform уже начал использоваться в предприятии, то он является наиболее предпочтительным  
      целевым инструментом для инициализации ресурсов , а  Ansible  - инструментом для управления конфигурацией .
  

- Хотите ли рассмотреть возможность внедрения новых инструментов для этого проекта? 

      Так как инфраструктура не отлажена, и конечный ее вид не известен, то пока имеющихся инструментов достаточно.

Что необходимо уточнить:

- Где будут размещаться вычислительные ресурсы для  разработки и продакшена - в облаке или на земле в локальном гипервизоре ?

      Если финтех или военка  - гарантированно, что информационная система  должна разворачиватся не на облачном сервисе , 
      а в локальном облаке или виртуальной среде. 
      Для инициализации ресурсов - проще использовать Packer ,
      а как средство CI/CD для создания пайплайнов - продолжать использвать Jetbrains TeamCity , 
      причем условно безопасный on-premise вариант.  
    
      Если это проект в коммерческой компании - проще иcпользаать публичные облачные сервисы типа Yandex Cloud  
      и  использовать  Terrafrom.
      Здесь в роли средства CI/CD для создания пайплайнов можно смело использовать  облачные ресурсы GitLab или GITHUB. 

- Необходимо выяснить какой примерно масштаб проекта - на какой масштаб аудитории на Frontend  
  и на какую примерную  вычислительную нагрузку в Backend  он будет расчитан.
- Также необходимо хотя примерно определить  уровень компетенций  местных сотрудников в наиболее популярных 
  инструментах Devops - индустрии.

        Продожать использовать, например, Kubernetis  как средство оркестрации - один из ключевых инструментов  
        в силу отсутствия в штате квалифицированных специалистов  или маленького масштаба проекта - нецелесообразно.
        Kubernetis  целесообразно использовать при огромных  планируемых объемах инфраструктуры 
        (от сотен развертываемых экземпляров виртуалок ). 

        При малых масштабах  проекта ( до сотни развертываемых экземпляров виртуалок инфраструктуры ) 
        удобнее будет использовать Docker Swarm.

- На следующем этапе  (или параллельно запущенном  проектах)  нужно срочно будет 

        а) Избавляться  от AWS-ресурсов и переводить их в локальное облако или YC.
           В таком размещении ресурсов слишком высоки риски для бизнеса.
        б) Избавляется от локальных скриптов bash, потому что они плохо вписываются в концепцию декларативного подхода  
           при развертывании инфраструктуры в облаке.


---
### Задача 2. Установка терраформ.
Официальный сайт: https://www.terraform.io/

Установите терраформ при помощи менеджера пакетов используемого в вашей операционной системе. 
В виде результата этой задачи приложите вывод команды terraform --version.

---
### Ответ:

- Находим  версию 1.2.9 и скачиваем ее c зеркала Yandex-Cloud

      root@docker:# wget https://hashicorp-releases.yandexcloud.net/terraform/1.2.9/terraform_1.2.9_linux_amd64.zip

- Распаковываем и устанавливаем: 

      root@docker:/home/bes/#  unzip terraform_1.2.9_linux_amd64.zip  && rm terraform_1.2.9_linux_amd64.zip
      root@docker:/home/bes/#  mv  terraform  /usr/local/bin

- Проверяем установку

      root@docker:/home/bes/#  terraform --version
      Terraform v1.2.9
      on linux_amd64

      Your version of Terraform is out of date! The latest version
      is 1.3.2. You can update by downloading from https://www.terraform.io/downloads.html


---
### Задача 3. Поддержка легаси кода.
В какой-то момент вы обновили терраформ до новой версии, например с 0.12 до 0.13. 
А код одного из проектов настолько устарел, что не может работать с версией 0.13. 
В связи с этим необходимо сделать так, чтобы вы могли одновременно использовать последнюю версию терраформа установленную 
при помощи штатного менеджера пакетов и устаревшую версию 0.12.

В виде результата этой задачи приложите вывод --version двух версий терраформа доступных на вашем компьютере или виртуальной машине.

---
### Ответ:

Вариант 1

- Переносим в личный рабочий каталог старую версию terraform 12

      root@docker:/usr#   cd  &&  mkdir $HOME/.local/bin
      root@docker:#   PATH=$PATH:$HOME/.local/bin 
      root@docker:#   export PATH
      root@docker:# mv  terraform  /$HOME/.local/bin/tf12

- Находим свежую версию 1.3.2 и скачиваем ее c зеркала Yandex-Cloud 

      root@docker:/home/bes/# wget  https://hashicorp-releases.yandexcloud.net/terraform/1.3.2/terraform_1.3.2_linux_amd64.zip

- Распаковываем и устанавливаем: 

      root@docker:/home/bes/# unzip terraform_1.3.2_linux_amd64.zip  && rm terraform_1.3.2_linux_amd64.zip
      root@docker:/home/bes/# mv  terraform  /usr/local/bin

- Проверяем обе версии:
 
      Старая версия:

      root@docker:~# whereis  tf12
      tf12: /root/.local/bin/tf12

      root@docker:~# tf12 --version | grep v1
      Terraform v1.2.9

      Новая версия:

      root@docker:~# whereis  terraform
      terraform: /usr/bin/terraform

      root@docker:~# terraform --version
      Terraform v1.3.2
      on linux_amd64

Вариант 2

1) Установка приложения tfswitch с помощью  curl 

       root@docker:~# curl -L https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh | bash
       % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                     Dload  Upload   Total   Spent    Left  Speed
       100  9216  100  9216    0     0  21333      0 --:--:-- --:--:-- --:--:-- 21284
       warrensbox/terraform-switcher info checking GitHub for latest tag
       warrensbox/terraform-switcher info found version: 0.13.1288 for 0.13.1288/linux/amd64
       warrensbox/terraform-switcher info installed /usr/local/bin/tfswitch

2) Выбираем и загружаем версии для использования  в каталог  /root/.terraform.versions,  
   указывая доступное  в России зеркало-репозиторий Yandex Cloud

       root@docker:~#   tfswitch  -s  1.2.9  --mirror  https://hashicorp-releases.yandexcloud.net/terraform/
       root@docker:~#   tfswitch  -s  1.3.2  --mirror  https://hashicorp-releases.yandexcloud.net/terraform/

3) Запускаем tfswitch  указывая в виде аргумента ту или иную  версию, которая в текущий момент необходима.

   Тогда  tfswitch создает линк terraform на исполняемый файл нужной версии:

       root@docker:~# tfswitch   1.2.9
       Switched terraform to version "1.2.9"

       root@docker:~# ls -la  /usr/local/bin
       total 23256
       drwxr-xr-x  2 root root     4096 Oct 10 04:29 .
       drwxr-xr-x 10 root root     4096 Feb 23  2022 ..
       -rwxr-xr-x  1 root root 13606047 Mar 22  2022 ctop
       lrwxrwxrwx  1 root root       41 Oct 10 04:29 terraform -> /root/.terraform.versions/terraform_1.2.9
       -rwxr-xr-x  1 root root 10199040 Oct 10 03:50 tfswitch
 
       root@docker:~# tfswitch   1.3.2
       root@docker:~# ls -la  /usr/local/bin
       total 23256
       drwxr-xr-x  2 root root     4096 Oct 10 04:27 .
       drwxr-xr-x 10 root root     4096 Feb 23  2022 ..
       -rwxr-xr-x  1 root root 13606047 Mar 22  2022 ctop
       lrwxrwxrwx  1 root root       41 Oct 10 04:29 terraform -> /root/.terraform.versions/terraform_1.3.2
       -rwxr-xr-x  1 root root 10199040 Oct 10 03:50 tfswitch


4) Можно создать  файл в рабочем каталоге .tfswitchrc , в котором указана желаемая версия

       root@docker:~#  echo "1.2.9" >> .tfswitchrc 

5) Тогда при запуске   tfswitch  без аргументов в каталоге с файлом  .tfswitchrc , конфигурация будет считана из него. 

       root@docker:~# tfswitch
       Reading file .tfswitchrc
       Switched terraform to version "1.2.9"

